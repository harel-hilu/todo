(()=>{"use strict";var e={n:n=>{var o=n&&n.__esModule?()=>n.default:()=>n;return e.d(o,{a:o}),o},d:(n,o)=>{for(var t in o)e.o(o,t)&&!e.o(n,t)&&Object.defineProperty(n,t,{enumerable:!0,get:o[t]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)};const n=require("express");var o=e.n(n);const t=require("cookie-parser");var i=e.n(t);const r=require("redis");var s=e.n(r);const c=require("uuid"),u=require("jsonwebtoken");var d=e.n(u),a=function(e,n,o,t){return new(o||(o=Promise))((function(i,r){function s(e){try{u(t.next(e))}catch(e){r(e)}}function c(e){try{u(t.throw(e))}catch(e){r(e)}}function u(e){var n;e.done?i(e.value):(n=e.value,n instanceof o?n:new o((function(e){e(n)}))).then(s,c)}u((t=t.apply(e,n||[])).next())}))};Function.prototype.promisify=function(e,...n){return new Promise(((o,t)=>{this.call(e,...n,((e,n)=>e?t(e):o(n)))}))};const v=require("dotenv");var f=function(e,n,o,t){return new(o||(o=Promise))((function(i,r){function s(e){try{u(t.next(e))}catch(e){r(e)}}function c(e){try{u(t.throw(e))}catch(e){r(e)}}function u(e){var n;e.done?i(e.value):(n=e.value,n instanceof o?n:new o((function(e){e(n)}))).then(s,c)}u((t=t.apply(e,n||[])).next())}))};(0,v.config)();const l=s().createClient(process.env.REDIS_URL),p=o()();p.set("views","./");const y=process.env.PORT||"3000";p.use(o().static(__dirname+"/public")),p.use(o().json()),p.use(i()()),p.use(((e,n,o)=>{return t=void 0,i=void 0,s=function*(){const t=e.cookies.todoUserId;if(t)try{const n=yield d().verify.promisify(null,t,process.env.TOKEN_SECRET);e.userId=n.userId}catch(e){console.log(e),n.status(401).send("You have no access!")}else{const o={userId:(0,c.v4)()};e.userId=o.userId;const t=d().sign(o,process.env.TOKEN_SECRET);n.cookie("todoUserId",t)}o()},new((r=void 0)||(r=Promise))((function(e,n){function o(e){try{u(s.next(e))}catch(e){n(e)}}function c(e){try{u(s.throw(e))}catch(e){n(e)}}function u(n){var t;n.done?e(n.value):(t=n.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,c)}u((s=s.apply(t,i||[])).next())}));var t,i,r,s})),p.get("/",((e,n)=>{n.render("index.ejs",{title:"Todo List"})})),p.get("/api/v1/tasks",((e,n)=>f(void 0,void 0,void 0,(function*(){const o=yield((e,n)=>a(void 0,void 0,void 0,(function*(){return function(e){const n={};for(const o in e)n[o]=JSON.parse(e[o]);return n}(yield e.hgetall.promisify(e,n))})))(l,e.userId);n.send(o)})))),p.post("/api/v1/tasks",((e,n)=>f(void 0,void 0,void 0,(function*(){const o=yield((e,n,o)=>a(void 0,void 0,void 0,(function*(){return o.id=o.id||(0,c.v4)(),yield e.hset.promisify(e,n,o.id,JSON.stringify(o)),o})))(l,e.userId,e.body);n.send(o)})))),p.delete("/api/v1/tasks/:taskId",((e,n)=>f(void 0,void 0,void 0,(function*(){yield((e,n,o)=>e.hdel.promisify(e,n,o))(l,e.userId,e.params.taskId),n.send()})))),p.listen(y,(()=>console.log(`listening on port ${y}`)))})();
//# sourceMappingURL=server.bundle.js.map